# DNSTOOL, an anonsurf companion tool for OpenNIC dns integration
#
# Devs:
# Nong Hoang 'DmKnght' Tu <dmknght@parrotsec.org>
# Lorenzo 'Palinuro' Faletra <palinuro@parrotsec.org>
#
# anonsurf and dnstool is free software: you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
# You can get a copy of the license at www.gnu.org/licenses
#
# anonsurf is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Parrot Security OS. If not, see <http://www.gnu.org/licenses/>.

BLUE='\033[1;94m'
GREEN='\033[1;92m'
RED='\033[1;91m'
RESETCOLOR='\033[1;00m'

function opennic() {

    rm /etc/resolv.conf

    echo -e "# File generated by DNSTOOL using the nearest OpenNIC servers provided by Parrot Security
# Parrot Security OpenNIC servers have strict zero log policy and publicly available configs
# Use the dnstool command to restore dhcp

" > /etc/resolv.conf

    echo "Parrot OpenNIC Servers" >> /etc/resolv.conf

    for I in $(host -t A director.geo.parrot.sh 1.1.1.1 | cut -d ' ' -f 4)
    do
        echo "nameserver $I" >> /etc/resolv.conf
    done

    echo "# Round Robin" >> /etc/resolv.conf
    echo "#options rotate" >> /etc/resolv.conf

    touch /etc/anonsurf/dnstool.lock
}

function dhcp() {
    if [ -f /etc/anonsurf/dnstool.lock ]; then
        rm /etc/anonsurf/dnstool.lock
    fi

    rm /etc/resolv.conf
    ln -s /run/resolvconf/resolv.conf /etc/resolv.conf
}

function status() {
    rcstatus=$(service resolvconf status | grep Active | cut -d ' ' -f 7)
    echo "Resolvconf status: $rcstatus"

    #if symlink

    #if not symlink && opennic

    #if not symlink && not opennic



}

case "$1" in
	opennic|start|o)
        opennic
	;;
    dhcp|stop|d)
        dhcp
    ;;
    status)
        status
    ;;
   *)
echo -e "DNSTOOL, the Anonsurf DNS companion (v 0.1)
    Developed by Lorenzo \"Palinuro\" Faletra <palinuro@parrotsec.org>
            Nong Hoang \"DmKnght\" Tu <dmknght@parrotsec.org>
            and a huge amount of Caffeine, Mountain Dew + some GNU/GPL v3 stuff

    Choose wether to dinamically pick the DNS IP provided by your local DHCP server
    or statically use the fastest OpenNIC servers available based on your IP location

    Usage:
    $RED┌──[$GREEN$USER$YELLOW@$BLUE`hostname`$RED]─[$GREEN$PWD$RED]
    $RED└──╼ \$$GREEN"" dnstool $RED{$GREEN""opennic$RED|$GREEN""dhcp$RED}

    $RED opennic$BLUE -$GREEN Determine the fastest OpenNIC server and enable it
    $RED dhcp$BLUE -$GREEN Use the DNS server announced by your internet provider
    $RED start$BLUE -$GREEN Alias of dnstool opennic
    $RED stop$BLUE -$GREEN Alias of dnstool dhcp
    $RED status$BLUE -$GREEN Check the status of dns settings
$RESETCOLOR
Dance like no one's watching. Encrypt like everyone is.
" >&2

exit 1
;;
esac

echo -e $RESETCOLOR
exit 0